databaseChangeLog:
  - changeSet:
      id: 004-create-job-orders-table
      author: wf-system
      changes:
        - createTable:
            tableName: job_orders
            remarks: Job orders created by employers for workforce recruitment
            columns:
              - column:
                  name: id
                  type: uuid
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_job_orders
                  defaultValueComputed: gen_random_uuid()

              - column:
                  name: employer_id
                  type: uuid
                  constraints:
                    nullable: false

              - column:
                  name: demand_letter_id
                  type: uuid
                  constraints:
                    nullable: true

              - column:
                  name: order_number
                  type: varchar(50)
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk_job_orders_number

              - column:
                  name: job_title
                  type: varchar(255)
                  constraints:
                    nullable: false

              - column:
                  name: job_category
                  type: varchar(100)
                  constraints:
                    nullable: false

              - column:
                  name: required_quantity
                  type: integer
                  constraints:
                    nullable: false

              - column:
                  name: filled_quantity
                  type: integer
                  constraints:
                    nullable: false
                  defaultValue: 0

              - column:
                  name: job_description
                  type: text
                  constraints:
                    nullable: false

              - column:
                  name: salary_min
                  type: decimal(10,2)
                  constraints:
                    nullable: false

              - column:
                  name: salary_max
                  type: decimal(10,2)
                  constraints:
                    nullable: false

              - column:
                  name: currency
                  type: varchar(3)
                  constraints:
                    nullable: false
                  defaultValue: AED

              - column:
                  name: contract_duration_months
                  type: integer
                  constraints:
                    nullable: false

              - column:
                  name: probation_period_months
                  type: integer
                  constraints:
                    nullable: false
                  defaultValue: 6

              - column:
                  name: working_hours
                  type: varchar(255)
                  constraints:
                    nullable: true

              - column:
                  name: benefits
                  type: text
                  constraints:
                    nullable: true

              - column:
                  name: required_start_date
                  type: date
                  constraints:
                    nullable: true

              - column:
                  name: status
                  type: varchar(30)
                  constraints:
                    nullable: false
                  defaultValue: draft
                  remarks: Enum - draft, submitted, under_validation, validated, open_for_sourcing, filled, deployed, closed

              - column:
                  name: validated_by
                  type: uuid
                  constraints:
                    nullable: true
                  remarks: Reference to user service (Workforce UAE validator)

              - column:
                  name: validated_at
                  type: timestamp with time zone
                  constraints:
                    nullable: true

              - column:
                  name: created_by
                  type: uuid
                  constraints:
                    nullable: false
                  remarks: Reference to user service (employer user)

              - column:
                  name: created_at
                  type: timestamp with time zone
                  constraints:
                    nullable: false
                  defaultValueComputed: current_timestamp

              - column:
                  name: updated_at
                  type: timestamp with time zone
                  constraints:
                    nullable: false
                  defaultValueComputed: current_timestamp

        - addForeignKeyConstraint:
            baseTableName: job_orders
            baseColumnNames: employer_id
            referencedTableName: employers
            referencedColumnNames: id
            constraintName: fk_job_orders_employer
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: job_orders
            baseColumnNames: demand_letter_id
            referencedTableName: demand_letters
            referencedColumnNames: id
            constraintName: fk_job_orders_demand_letter
            onDelete: SET NULL

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_quantity_positive
            checkCondition: "required_quantity > 0"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_filled_non_negative
            checkCondition: "filled_quantity >= 0"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_filled_not_exceed
            checkCondition: "filled_quantity <= required_quantity"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_salary_range
            checkCondition: "salary_min > 0 AND salary_max >= salary_min"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_contract_duration
            checkCondition: "contract_duration_months > 0 AND contract_duration_months <= 60"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_probation_period
            checkCondition: "probation_period_months >= 0 AND probation_period_months <= 12"

        - addCheckConstraint:
            tableName: job_orders
            constraintName: chk_job_orders_status
            checkCondition: "status IN ('draft', 'submitted', 'under_validation', 'validated', 'open_for_sourcing', 'filled', 'deployed', 'closed')"

